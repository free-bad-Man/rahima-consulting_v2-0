#!/bin/bash
# –°–∫—Ä–∏–ø—Ç push: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
# –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/free-bad-Man/rahima-consalting.git
# –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

REPO_URL="https://github.com/free-bad-Man/rahima-consalting.git"
BRANCH="main"

echo -e "${BLUE}üöÄ Git Push –≤ GitHub${NC}"
echo -e "${YELLOW}–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $REPO_URL${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: —ç—Ç–æ –Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π${NC}"
    echo -e "${YELLOW}üí° –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: git init${NC}"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–µ–∫—Ä–µ—Ç—ã
check_secrets() {
    local files_to_check=$(git diff --cached --name-only 2>/dev/null || git ls-files 2>/dev/null || echo "")
    
    if [ -z "$files_to_check" ]; then
        return 0
    fi
    
    echo -e "${BLUE}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤...${NC}"
    
    # –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
    local secret_patterns=(
        "password.*=.*[^=]{8,}"
        "secret.*=.*[^=]{8,}"
        "token.*=.*[^=]{16,}"
        "api_key.*=.*[^=]{16,}"
        "private_key.*=.*[^=]{16,}"
        "GOOGLE_CLIENT_SECRET.*=.*GOCSPX-"
        "NEXTAUTH_SECRET.*=.*[^=]{16,}"
        "SMTP_PASSWORD.*=.*[^=]{4,}"
        "POSTGRES_PASSWORD.*=.*[^=]{4,}"
        "AMOCRM.*SECRET.*=.*[^=]{16,}"
        "AMOCRM_AUTH_CODE.*=.*[^=]{32,}"
        "N8N_ENCRYPTION_KEY.*=.*[^=]{8,}"
        "N8N_CALLBACK_SECRET.*=.*[^=]{16,}"
    )
    
    local found_secrets=false
    
    for file in $files_to_check; do
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ–∞–π–ª—ã (—à–∞–±–ª–æ–Ω—ã, —Å–∫—Ä–∏–ø—Ç—ã, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
        if [[ "$file" == *".env"* ]] || \
           [[ "$file" == *"docker-compose.yml" ]] || \
           [[ "$file" == *".secret"* ]] || \
           [[ "$file" == *".example"* ]] || \
           [[ "$file" == "push" ]] || \
           [[ "$file" == "pull" ]] || \
           [[ "$file" == *"SECURITY.md" ]] || \
           [[ "$file" == *"README"* ]]; then
            continue
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
        if [ -f "$file" ] && file "$file" | grep -q "text"; then
            for pattern in "${secret_patterns[@]}"; do
                # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º —Å–µ–∫—Ä–µ—Ç–∞
                matching_lines=$(grep -iE "$pattern" "$file" 2>/dev/null || true)
                
                if [ -n "$matching_lines" ]; then
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
                    while IFS= read -r line; do
                        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å process.env –∏–ª–∏ ${VAR} (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
                        if ! echo "$line" | grep -qiE "(process\.env|\\\$\{)" 2>/dev/null; then
                            # –≠—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç, –∞ –Ω–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
                            echo -e "${RED}‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ —Ñ–∞–π–ª–µ: $file${NC}"
                            echo -e "${YELLOW}   –ü–∞—Ç—Ç–µ—Ä–Ω: $pattern${NC}"
                            echo -e "${YELLOW}   –°—Ç—Ä–æ–∫–∞: ${line:0:80}...${NC}"
                            found_secrets=true
                            break  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞ –≤ —Ñ–∞–π–ª–µ
                        fi
                    done <<< "$matching_lines"
                fi
            done
        fi
    done
    
    if [ "$found_secrets" = true ]; then
        echo ""
        echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò!${NC}"
        echo -e "${YELLOW}–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ —Ñ–∞–π–ª–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ GitHub!${NC}"
        echo ""
        echo -e "${BLUE}–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:${NC}"
        echo -e "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ .gitignore"
        echo -e "2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env —Ñ–∞–π–ª—ã) –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤"
        echo -e "3. –î–ª—è docker-compose.yml –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ docker-compose.yml.example –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤"
        echo ""
        read -p "$(echo -e ${YELLOW}–í—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? [y/N]: ${NC})" -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º${NC}"
            exit 1
        fi
    else
        echo -e "${GREEN}‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞${NC}"
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è remote
if ! git remote | grep -q "origin"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Remote 'origin' –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤–ª—è—é...${NC}"
    git remote add origin "$REPO_URL"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ URL remote
CURRENT_URL=$(git remote get-url origin 2>/dev/null || echo "")
if [ "$CURRENT_URL" != "$REPO_URL" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  URL remote –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è. –û–±–Ω–æ–≤–ª—è—é...${NC}"
    git remote set-url origin "$REPO_URL"
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ GitHub
push_to_github() {
    echo -e "${GREEN}‚¨ÜÔ∏è  –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ GitHub (branch: $BRANCH)...${NC}"
    if git push -u origin "$BRANCH" 2>&1; then
        echo -e "${GREEN}‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ GitHub!${NC}"
        echo -e "${BLUE}üîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $REPO_URL${NC}"
        return 0
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ${NC}"
        echo ""
        echo -e "${YELLOW}üí° –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π GitHub${NC}"
        echo -e "${BLUE}–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Personal Access Token:${NC}"
        echo -e "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: https://github.com/settings/tokens"
        echo -e "2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π token (classic) —Å –ø—Ä–∞–≤–∞–º–∏ 'repo'"
        echo -e "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ token –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ"
        echo ""
        echo -e "${YELLOW}–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSH:${NC}"
        echo -e "git remote set-url origin git@github.com:free-bad-Man/rahima-consalting.git"
        return 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
UNCOMMITTED=$(git status --porcelain)
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–º–∏—Ç—ã
UNPUSHED_COUNT=$(git rev-list --count origin/$BRANCH..HEAD 2>/dev/null || echo "0")

# –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–∏ –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤
if [ -z "$UNCOMMITTED" ] && [ "$UNPUSHED_COUNT" = "0" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –∏ –Ω–µ—Ç –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤${NC}"
    exit 0
fi

# –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–º–∏—Ç—ã, –Ω–æ –Ω–µ—Ç –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
if [ -z "$UNCOMMITTED" ] && [ "$UNPUSHED_COUNT" != "0" ]; then
    echo -e "${BLUE}üìä –ï—Å—Ç—å –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–º–∏—Ç—ã ($UNPUSHED_COUNT):${NC}"
    git log origin/$BRANCH..HEAD --oneline 2>/dev/null || git log --oneline -5
    echo ""
    read -p "$(echo -e ${YELLOW}–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–∏—Ç—ã –≤ GitHub? [y/N]: ${NC})" -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ${NC}"
        exit 0
    fi
    
    if push_to_github; then
        exit 0
    else
        exit 1
    fi
fi

# –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—ã—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
echo -e "${BLUE}üìä –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω–∏–π:${NC}"
git status --short
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ–∫—Ä–µ—Ç—ã –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
check_secrets

# –°–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
read -p "$(echo -e ${YELLOW}–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? [y/N]: ${NC})" -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ${NC}"
    exit 0
fi

# –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "${GREEN}üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...${NC}"
git add .

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ–∫—Ä–µ—Ç—ã –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
check_secrets

# –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ
echo -e "${BLUE}üìù –§–∞–π–ª—ã –¥–ª—è –∫–æ–º–º–∏—Ç–∞:${NC}"
git status --short
echo ""

# –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
if [ -z "$1" ]; then
    read -p "$(echo -e ${YELLOW}–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${NC})" COMMIT_MSG
    if [ -z "$COMMIT_MSG" ]; then
        COMMIT_MSG="Update: $(date '+%Y-%m-%d %H:%M:%S')"
        echo -e "${YELLOW}üí° –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $COMMIT_MSG${NC}"
    fi
else
    COMMIT_MSG="$1"
fi

# –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç
echo -e "${GREEN}üíæ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞...${NC}"
git commit -m "$COMMIT_MSG"

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ GitHub
if ! push_to_github; then
    exit 1
fi

