#!/bin/bash
# –°–∫—Ä–∏–ø—Ç pull: –ø–æ–ª—É—á–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
# –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/free-bad-Man/rahima-consalting.git

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

REPO_URL="https://github.com/free-bad-Man/rahima-consalting.git"
BRANCH="main"

echo -e "${BLUE}‚¨áÔ∏è  Git Pull –∏–∑ GitHub${NC}"
echo -e "${YELLOW}–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $REPO_URL${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d ".git" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é...${NC}"
    git init
    git remote add origin "$REPO_URL" 2>/dev/null || git remote set-url origin "$REPO_URL"
    echo -e "${GREEN}‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
if [ -n "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:${NC}"
    git status --short
    echo ""
    read -p "$(echo -e ${YELLOW}–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? –ò–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã. [y/N]: ${NC})" -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ${NC}"
        exit 0
    fi
    
    # –°–ø—Ä–æ—Å–∏—Ç—å, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    read -p "$(echo -e ${YELLOW}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash? [y/N]: ${NC})" -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ stash...${NC}"
        git stash push -m "Auto-stash before pull $(date '+%Y-%m-%d %H:%M:%S')"
        STASHED=true
    else
        echo -e "${YELLOW}‚ö†Ô∏è  –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã${NC}"
        STASHED=false
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è remote
if ! git remote | grep -q "origin"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Remote 'origin' –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤–ª—è—é...${NC}"
    git remote add origin "$REPO_URL"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ URL remote
CURRENT_URL=$(git remote get-url origin 2>/dev/null || echo "")
if [ "$CURRENT_URL" != "$REPO_URL" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  URL remote –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è. –û–±–Ω–æ–≤–ª—è—é...${NC}"
    git remote set-url origin "$REPO_URL"
fi

# Fetch –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "${GREEN}üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub...${NC}"
git fetch origin "$BRANCH" || {
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π${NC}"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –¥–ª—è pull
LOCAL=$(git rev-parse @ 2>/dev/null || echo "")
REMOTE=$(git rev-parse @{u} 2>/dev/null || echo "")

if [ -z "$LOCAL" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞—é –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ $BRANCH...${NC}"
    git checkout -b "$BRANCH" 2>/dev/null || git checkout "$BRANCH" 2>/dev/null || true
    git branch --set-upstream-to=origin/"$BRANCH" "$BRANCH" 2>/dev/null || true
fi

if [ "$LOCAL" = "$REMOTE" ] && [ -n "$LOCAL" ]; then
    echo -e "${GREEN}‚úÖ –£–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ. –ù–µ—Ç –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π${NC}"
else
    # Pull –∏–∑–º–µ–Ω–µ–Ω–∏–π
    echo -e "${GREEN}‚¨áÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (branch: $BRANCH)...${NC}"
    if git pull origin "$BRANCH" --no-edit; then
        echo -e "${GREEN}‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ –∏–∑ GitHub!${NC}"
        
        # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤
        if [ -f "docker-compose.yml.example" ] && [ ! -f "docker-compose.yml" ]; then
            echo ""
            echo -e "${YELLOW}‚ö†Ô∏è  –í–ê–ñ–ù–û: –û–±–Ω–∞—Ä—É–∂–µ–Ω docker-compose.yml.example${NC}"
            echo -e "${BLUE}–°–æ–∑–¥–∞–π—Ç–µ docker-compose.yml –Ω–∞ –æ—Å–Ω–æ–≤–µ docker-compose.yml.example${NC}"
            echo -e "${BLUE}–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è${NC}"
        fi
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π${NC}"
        echo -e "${YELLOW}üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:${NC}"
        echo -e "   - –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–ª–∏—è–Ω–∏—è"
        echo -e "   - –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é"
        exit 1
    fi
fi

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å stash, –µ—Å–ª–∏ –±—ã–ª —Å–æ–∑–¥–∞–Ω
if [ "$STASHED" = true ]; then
    if git stash list | grep -q "Auto-stash before pull"; then
        echo -e "${GREEN}üì¶ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π...${NC}"
        git stash pop || {
            echo -e "${YELLOW}‚ö†Ô∏è  –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ stash. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:${NC}"
            echo -e "   ${BLUE}git stash list${NC} - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å stash"
            echo -e "   ${BLUE}git stash pop${NC} - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é"
        }
    fi
fi

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
echo ""
echo -e "${BLUE}üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:${NC}"
git status --short

echo ""
echo -e "${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ!${NC}"
echo -e "${BLUE}üîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $REPO_URL${NC}"

